
## Description

The [telegram](https://telegram.org/) service is a platform for message exchange with a focus on speed and safety. Service is very simple and free. Applications for operation with the service are available for a variety of platforms – mobile phones, tablets, computers – you can use the telegram on all devices simultaneously. Also by means of this service by simple [API](https://core.telegram.org/bots/api) it is possible to create bots (the virtual companions). Driver **telegram **(Telegram Adapter) allows to send and receive messages, that is to exchange telegrams with the ioBroker system, having [created a bot](https://core.telegram.org/bots/faq#how-do-i-create-a-bot) in the telegram service. It is possible to give a bot different commands (to turn on the light, to open garage gate and so forth), it is possible to request any information (temperature in the house, a status of system of heating and so forth), the bot can publish snapshots from security video cameras when actuating the motion sensor, generally the functionality of this decision is very rich. The driver can be used together with the [text2command](httphttp://www.iobroker.net/?page_id=4711&lang=en) adapter.

## Information


## <span id="i-3">Installation</span>

Installation is on the **Adapters** tab page [administration](http://www.iobroker.net/?page_id=4179&lang=en) system. In the driver group **communication **find a line called **Telegram Adapter**, and press the button with the plus icon in the right side of the line. [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic1-1024x190.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic1.png) You will see a pop-up window driver installation, after installation, it will automatically close. [![](http://www.iobroker.net/wp-content/uploads//telegram-install2.jpg)](http://www.iobroker.net/wp-content/uploads//telegram-install2.jpg) If all goes well, on the **Settings driver** tab will be a line **telegram.0** with installed driver instance. [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic2-1024x319.png)](img/telegramm_pic2.png)

## <span id="i-3">Setting</span>

### Registration and creation of a bot

To configure the driver, you must first create a bot for ioBroker management. If you do not have an account in the telegram service, it's time to create it, to do this, go to the [link](https://web.telegram.org/#/login) (web client, it is possible also through an installed application) and register. Then create a bot, for that purpose follow the [link](https://telegram.me/botfather), if you use web client or contact search bar looking for a user named **@BotFather** and begin a dialogue with him. [![](http://www.iobroker.net/wp-content/uploads//telegram-setting1.jpg)](http://www.iobroker.net/wp-content/uploads//telegram-setting1.jpg) So, we create a new bot, give the command /`newbot`. Next in the dialog you will be asked to write the name of your bot - invent name, input it and press enter. Then you need to enter user name and it must end with the word `bot`. Username must be unique, so if the name you entered is already taken, you will be warned about it and will ask to invent another. The ultimate goal of the dialogue is the passkey to use API HTTP (token access HTTP API). [![](http://www.iobroker.net/wp-content/uploads//telegram-setting2.jpg)](http://www.iobroker.net/wp-content/uploads//telegram-setting2.jpg) Now, for security, you should set a password to communicate with the bot. To do this, open a dialogue with the newly created interlocutor and type the command `/password security`, where the word **security** - is the password (create your own). [![](img/telegram-setting3.jpg)](img/telegram-setting3.jpg)

### Setting the telegram driver

Now you can open the telegram driver settings in the ioBroker system (**driver settings** tab) and to input there a key, the password, and if you plan to use **text2command**, to select an instance of this driver from the list. [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic3-1024x492.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic3.png)   Run the configured telegram driver instance on the **Settings driver tab**, click **Inactive** button. **Click to start** (the red button with the play icon). [![](http://www.iobroker.net/wp-content/uploads//telegram-setting5.jpg)](http://www.iobroker.net/wp-content/uploads//telegram-setting5.jpg) Go to the **Log** tab and make sure that the driver is connected to the service telegram and that there are no errors. [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic7-1024x114.png)](img/telegramm_pic7.png) Well, the driver is configured.

## Examples of use

### Working together with the text2command driver

To work in conjunction with the text2command driver, you need to select the installed text2command driver instance from settings of the telegram adapter, as it is described [above](http://www.iobroker.net/?page_id=6624&lang=en#Setting_the_telegram_driver). [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic4-1024x394.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic4.png)   Let's add several simple rules for an example – the rule, **How many time, What is your name and Temperature on the street**. [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic5-1024x124.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic5.png)   That’s all! Now you can open a dialogue with the bot, log in and ask questions: [![](http://www.iobroker.net/wp-content/uploads//telegram-use2-1-300x212.jpg)](http://www.iobroker.net/wp-content/uploads//telegram-use2-1.jpg)   However, it should be noted that the full type of commands and questions to a bot it is not so convenient, especially on mobile devices. For a bot, you can specify a list of quick commands for faster input - is enough to write the character "/" and appears a list of pre-defined commands - you just select the required. To do this, we turn again to the user **@BotFather**. Enter the command `/setcommands`, then type the name of the created bot starting with "@" symbol. [![](img/telegram-use3.jpg)](img/telegram-use3.jpg) Enter the command in the format: `Command – description`

*   - command - short name of the command is written as one word with no spaces (can be through a sign underscore)
*   - вescription - a short description of the command

Each command from a new line, in the application we use the Ctrl+Enter keyboard shortcut. [![](http://www.iobroker.net/wp-content/uploads//telegram_pic12-300x262.png)](http://www.iobroker.net/wp-content/uploads//telegram_pic12.png)   Now you have to edit the rules a bit that keywords of commands matched: [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic5-1024x124.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic5.png)   Now it is possible in a chat with a bot to write the choice command character "/" and on the screen to be displayed the list. [![](http://www.iobroker.net/wp-content/uploads//telegram_pic11-300x238.png)](http://www.iobroker.net/wp-content/uploads//telegram_pic11.png)  

### Remote server reboot

Let's review an example more difficult. Suppose you want to build a command that would be perceived by the bot, and rebooted the server. To do this, you need installed and configured telegram driver, text2command and javascript. In the javascript.0 driver instance will create a script called **t2c_restartSystem** and the following contents: `createState('t2c_restartSystem.restart_command', '');` `on({id: 'javascript.0.t2c_restartSystem.restart_command', change: 'any'}, function (obj) {` `  if (obj.newState.val === true || obj.newState.val === 'true'){` `      log('Command reboot');` `      setState('javascript.0.t2c_restartSystem.restart_command', 'false');` `      exec ('reboot');` `  }` `});` In a script create the `javascript.0.t2c_restartSystem.restart_command` variable and subscribe to it. On a condition of new `true` value, give the message in a log, reset the value of the variable to `false` and perform a reboot command. Let's add the new rule to the text2command driver: [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic6-1024x144.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic6.png)   Now, in the telegram dialogue with the user **@BotFather** add command `/restart_iobroker` (really do not need to add a command, but rather to prescribe all possible, that is, re-enter the previously created). [![](http://www.iobroker.net/wp-content/uploads//telegram_pic10-300x157.png)](http://www.iobroker.net/wp-content/uploads//telegram_pic10.png)   That's all, you can check how the newly created command is working: [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic9-300x134.png)](http://www.iobroker.net/wp-content/uploads//telegramm_pic9.png)

### Publication snapshots of IP cameras for motion sensor

In addition to commands, the bot can send messages on any event or a picture/photo. So, the next task:

*   there is a D-Link DSC-900 IP camera, the address in networks 192.168.69.81, the stream address mjpeg http://192.168.69.81/mjpeg.cgi, the address for image capture – http://192.168.69.81/image.jpg
*   in a security zone of the camera watches the motion sensor connected to the controller based on arduino MEGA + Ethernet shield, data transmission protocol MQTT, the `mqtt.0.arduino56.PIR2` variable is set to `true` (there is a movement), `false` (there is no movement)
*   when actuating the motion sensor, it is necessary to send in telegrams images to timepoints 0, 10, 20 seconds after actuating of the sensor.

Write a script of the following contents: `var request = require('request'); //for an image request from the camera` `var fs = require('fs'); //for temporal saving the image in the form of the file` `//Function which requests the image from the camera, saves it in the temporal file and sends it to the telegram driver` `function sendImage() {` `  request.get({url: 'http://192.168.69.81/image.jpg', encoding: 'binary'}, function (err, response, body) {` `    fs.writeFile("/tmp/snapshot.jpg", body, 'binary', function(err) {` `      if (err) {` `        console.error(err);` `      } else {` `        sendTo('telegram.0', '/tmp/snapshot.jpg');` `      }` `    });` `  });` `}` `//Subscribe for the mqtt.0.arduino56.PIR2 variable as soon as true value, send the current image and two more with the period 10 sec` `on({id: 'mqtt.0.arduino56.PIR2', change: 'any'}, function (obj) {` `  if (obj.newState.val === true || obj.newState.val === 'true'){` `    console.log('Оbserved the movement! Snapshot sent to telegram');` `    sendTo('telegram.0', 'Attention! Motion! Publishing the image');` `    sendImage();` `    setTimeout(sendImage, 10000);` `    setTimeout(sendImage, 20000);` `  }` `});` The result should be something like this: [![](http://www.iobroker.net/wp-content/uploads//telegramm_pic8-300x296.png)](img/telegramm_pic8.png)